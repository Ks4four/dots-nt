name: Build Aporetic Fonts

on:
  workflow_dispatch: # 允许你在 GitHub 网页上手动点击按钮触发构建
  push:
    paths:
      - 'fonts/private-build-plans.toml' # 当你修改这个配置文件并推送时自动触发

jobs:
  build:
    name: Build ${{ matrix.plan }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # 这里列出了你配置文件中定义的四个构建计划名称
        plan: [aporetic-sans-mono, aporetic-sans, aporetic-serif-mono, aporetic-serif]

    steps:
      - name: Checkout Dotfiles
        uses: actions/checkout@v4
        with:
          path: dotfiles

      - name: Checkout Iosevka Repo
        uses: actions/checkout@v4
        with:
          repository: be5invis/Iosevka
          path: Iosevka
          fetch-depth: 1 # 只拉取最新代码，节省时间

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ttfautohint
          npm install -g pnpm

      - name: Prepare Build
        working-directory: ./Iosevka
        run: |
          # 安装 Iosevka 的依赖
          npm install
          # 将你的配置文件复制到 Iosevka 的构建目录中
          cp ../dotfiles/fonts/private-build-plans.toml .

      - name: Build TTF
        working-directory: ./Iosevka
        run: |
          # 运行构建命令
          npm run build -- ttf::${{ matrix.plan }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: font-${{ matrix.plan }}
          path: Iosevka/dist/${{ matrix.plan }}/ttf/*.ttf
          retention-days: 5