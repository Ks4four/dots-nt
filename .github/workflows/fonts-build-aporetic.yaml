name: Build Aporetic Fonts

on:
  workflow_dispatch:
  push:
    paths:
      - 'fonts/private-build-plans.toml'

jobs:
  build:
    name: Build ${{ matrix.plan }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        plan: [aporetic-sans-mono, aporetic-sans, aporetic-serif-mono, aporetic-serif]

    steps:
      - name: Checkout Dotfiles
        uses: actions/checkout@v4
        with:
          path: dotfiles

      - name: Checkout Iosevka Repo
        uses: actions/checkout@v4
        with:
          repository: be5invis/Iosevka
          path: Iosevka
          # 修复: 移除 fetch-depth: 1，改用 filter: blob:none
          # 这是一种"无树克隆"，对于巨型仓库比浅克隆更稳定，且速度也很快
          filter: blob:none 

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ttfautohint
          npm install -g pnpm

      - name: Prepare Build
        working-directory: ./Iosevka
        run: |
          npm install
          # 复制配置文件
          cp ../dotfiles/fonts/private-build-plans.toml .
          # 验证文件是否复制成功 (用于调试)
          ls -l private-build-plans.toml

      - name: Build TTF
        working-directory: ./Iosevka
        run: |
          # 增加 --no-save 防止 npm 试图写入 package-lock.json 导致权限问题
          npm run build -- ttf::${{ matrix.plan }} --no-save

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: font-${{ matrix.plan }}
          path: Iosevka/dist/${{ matrix.plan }}/ttf/*.ttf
          if-no-files-found: warn
          retention-days: 5