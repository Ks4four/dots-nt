name: Build Aporetic Fonts

on:
  workflow_dispatch:
  push:
    paths:
      - 'fonts/private-build-plans.toml'
      - '.github/workflows/fonts-build-aporetic.yaml'

jobs:
  build:
    name: Build ${{ matrix.plan }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        plan: [aporetic-sans-mono, aporetic-sans, aporetic-serif-mono, aporetic-serif]

    steps:
      - name: Checkout Dotfiles
        uses: actions/checkout@v4
        with:
          path: dotfiles
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ttfautohint

      - name: Download Iosevka Source
        run: |
          echo "Downloading Iosevka v32.5.0..."
          wget -q https://github.com/be5invis/Iosevka/archive/refs/tags/v32.5.0.zip -O iosevka.zip
          unzip -q iosevka.zip
          mv Iosevka-32.5.0 Iosevka

      - name: Build TTF
        working-directory: ./Iosevka
        run: |
          npm install

          echo "Copying configuration..."
          cp ../dotfiles/fonts/private-build-plans.toml .

          # === 自动修复步骤 ===
          # Iosevka v32 中 cv65 (Thorn) 没有选项 4 了，这里自动将其改为 1 (标准样式)
          # 同时也检查并修复 cv65 在 serif 里的配置
          echo "Patching invalid cv65 value..."
          sed -i 's/cv65 = 4/cv65 = 1/g' private-build-plans.toml
          
          # 验证修复结果
          grep "cv65" private-build-plans.toml

          echo "Building ${{ matrix.plan }}..."
          npm run build -- ttf::${{ matrix.plan }} --no-save

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: font-${{ matrix.plan }}
          path: Iosevka/dist/${{ matrix.plan }}/ttf/*.ttf
          if-no-files-found: warn
          retention-days: 5